#!/bin/bash

dir="$1"
cd "$1"

s="
set xlabel 'seconds'
set grid
set yrange [0:100]
set offset graph 0.02, 0.02
set key right top

plot \\"

for f in `ls *.dat`; do
  begin=`head -n1 "$f" | cut -d' ' -f1`
  end=`tail -n1 "$f" | cut -d' ' -f1`
  title="${f%.dat}"

  if [[ -z `echo $1 | grep -- "-down"` ]]; then
    io="'$f' using 1:(\$9/10) title '$title rtt' with lines, \
        '$f' using 1:(80+\$11/5) title '$title out frac' with lines, \
        '$f' using 1:(8*\$13/1000000) title '$title out speed' with lines,"
  else
    io="'$f' using 1:(\$10/10) title '$title rcv_rtt' with lines, \
        '$f' using 1:(80+\$12/5) title '$title in frac' with lines, \
        '$f' using 1:(8*\$14/1000000) title '$title in speed' with lines,"
  fi

  s="$s
    '$f' using 1:2 title '$title bitrate' with lines, \
    '$f' using 1:3 title '$title quality' with lines, \
    '$f' using 1:(100+\$4) title '$title signal' with lines, \
    '$f' using 1:5 title '$title tx-retry' with lines, \
    '$f' using 1:6 title '$title tx-misc' with lines, \
    '$f' using 1:7 title '$title fast rt' with lines, \
    '$f' using 1:8 title '$title slow rt' with lines, \
    $io \\"
done

echo "${s%, \\}" | gnuplot -p -
