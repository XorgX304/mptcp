#!/bin/bash

dir="$1"
cd "$1"

s="
set xlabel 'seconds'
set grid
set yrange [0:100]
set offset graph 0.02, 0.02
set key right top

plot \\"

for f in `ls *.dat`; do
  begin=`head -n1 "$f" | cut -d' ' -f1`
  end=`tail -n1 "$f" | cut -d' ' -f1`
  title="${f%.dat}"

  if [[ -z `echo $1 | grep -- "-down"` ]]; then
    io="'$f' using (\$1-$begin):(\$6/10) title '$title rtt' with lines, \
        '$f' using (\$1-$begin):(80+\$8/5) title '$title utilization' with lines, \
        '$f' using (\$1-$begin):(8*\$10/1000000) title '$title throughput' with lines,"
  else
    io="'$f' using (\$1-$begin):(\$7/10) title '$title rtt' with lines, \
        '$f' using (\$1-$begin):(80+\$9/5) title '$title utilization' with lines, \
        '$f' using (\$1-$begin):(8*\$11/1000000) title '$title throughput' with lines,"
  fi

  s="$s
    '$f' using (\$1-$begin):2 title '$title bitrate' with lines, \
    '$f' using (\$1-$begin):(100+\$3) title '$title signal' with lines, \
    '$f' using (\$1-$begin):4 title '$title tx-fail' with lines, \
    '$f' using (\$1-$begin):5 title '$title rx-drop' with lines, \
    $io \\"
done

echo "${s%, \\}" | gnuplot -p -
